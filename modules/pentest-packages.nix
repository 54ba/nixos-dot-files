{ config, pkgs, lib, ... }:

with lib;

{
  options = {
    custom.security = {
      pentest.enable = mkEnableOption "penetration testing packages";
      
      pentest.warning = mkOption {
        type = types.bool;
        default = true;
        description = "
          Show security warning when enabling penetration testing tools.
          These tools should only be used on systems you own or have explicit permission to test.
        ";
      };
    };
  };

  config = mkIf config.custom.security.pentest.enable {
    # Add penetration testing packages
    environment.systemPackages = import ../packages/pentest-packages.nix { inherit pkgs; };
    
    # Security-related system configuration
    # Only enable basic Tor if not already configured by privacy-circumvention module
    services.tor.enable = mkDefault (!config.custom.privacy-circumvention.enable);
    
    # Add warning message
    warnings = mkIf config.custom.security.pentest.warning [
      "
      ðŸ”’ PENETRATION TESTING TOOLS ENABLED ðŸ”’
      
      You have enabled penetration testing tools in your system configuration.
      These tools are powerful and should only be used:
      
      1. On systems you own
      2. On systems you have explicit written permission to test
      3. For legitimate security research or educational purposes
      
      Unauthorized use of these tools may violate local and international laws.
      The user is solely responsible for compliance with all applicable laws and regulations.
      
      To disable this warning, set: custom.security.pentest.warning = false;
      "
    ];
    
    # Create a desktop entry for pentest environment
    environment.etc."xdg/autostart/pentest-warning.desktop".text = mkIf config.custom.security.pentest.warning ''
      [Desktop Entry]
      Type=Application
      Name=Security Tools Warning
      Comment=Reminder about responsible use of security tools
      Exec=${pkgs.libnotify}/bin/notify-send "Security Tools Active" "Remember to use penetration testing tools responsibly and only on authorized systems."
      Icon=security-high
      Hidden=false
      NoDisplay=false
      X-GNOME-Autostart-enabled=true
    '';
  };
}

